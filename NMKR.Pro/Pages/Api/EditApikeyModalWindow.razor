@inject ISnackbar Snackbar
@inject IStringLocalizer _loc

<MudDialog Style="padding: 20px;">
    <TitleContent>
        <MudText Typo="Typo.h3">
        @_loc["Edit API Key"]
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField Variant="Variant.Outlined" Label="@_loc["Comment"]"  @bind-Value="apikey.Comment" Lines="1" Immediate="true" Class="mb-3" />
        <MudDatePicker PickerVariant="PickerVariant.Dialog" Culture="@(new CultureInfo("en-US"))" Label="@_loc["Expiration"]" DisplayMonths="2" TitleDateFormat="dddd, dd MMMM" @bind-Date="date"  />
    </DialogContent>
    <DialogActions>
        <MudButton DropShadow="false" Class="rounded-xl px-6 py-3" Variant="Variant.Outlined" OnClick="Cancel">@_loc["Cancel"]</MudButton>
        <MudButton DropShadow="false" Class="rounded-xl px-6 py-3" Variant="Variant.Filled" Color="Color.Tertiary" OnClick="CreateKey">@_loc["Save Apikey"]</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter]
    public Apikey apikey { get; set; }
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; }


    private bool isSubmitting;
    private DateTime? date { get; set; } = DateTime.Now.AddYears(1);

    void Cancel() => MudDialog.Cancel();

    protected override void OnParametersSet()
    {
        if (apikey != null)
            date = apikey.Expiration;
    }
    private async Task CreateKey()
    {
        await using var db = new EasynftprojectsContext(GlobalFunctions.optionsBuilder.Options);

        var ak = await (from a in db.Apikeys
                        where a.Id == apikey.Id
                        select a).FirstOrDefaultAsync();

        ak.Comment = apikey.Comment;
        ak.Expiration = (DateTime)date;


        await db.SaveChangesAsync();
        Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopCenter;
        Snackbar.Add(@_loc["Changes saved"], Severity.Success);
        MudDialog.Close(DialogResult.Ok(apikey));
    }

}
