@page "/managenft/{projectid:int}"
@page "/managenft/{projectid:int}/{nocache:int}"
@inject AppSettings settings
@inject NavigationManager NavigationManager
@inject IConnectionMultiplexer _redis;


<BreadCrumb Items="_items"></BreadCrumb>

<MudContainer MaxWidth="MaxWidth.False" Class="mt-4">
    <NftList projectid="@projectid" nocache="@nocache" IsAdmin="false" customerid="@((int)settings.UserId)" />
</MudContainer>


@code {
    [Parameter]
    public int projectid { get; set; }
    [Parameter]
    public int nocache { get; set; } = 0;

    private readonly List<BreadcrumbItem> _items = new()
    {
        new("Dashboard", href: "/"),
        new("NFT Projects", href: "/projects"),

    };

    private Nftproject project = new();
    protected override async Task OnParametersSetAsync()
    {
        if (projectid != 0)
        {
            await using var db = new EasynftprojectsContext(GlobalFunctions.optionsBuilder.Options);
            await LoadProject(db);
            if (project != null)
            {
                _items.Add(new($"Project ({project.Projectname})", href: $"/projects/{project.Uid}", disabled: false));
                _items.Add(new("Manage NFT (" + project.Id + " - " + project.Projectname + ")", href: "/managenft/" + projectid, disabled: true));
                StateHasChanged();
            }
        }
    }
 
    public async Task LoadProject(EasynftprojectsContext db)
    {
        string redisKey = $"{(GlobalFunctions.IsMainnet() ? "Mainnet" : "Testnet")}_Pro_LoadProject_{projectid}";

        var project1=RedisFunctions.GetData<Nftproject>(_redis, redisKey);

        if (project1 == null)
        {
            project = await (from a in db.Nftprojects
                where a.Id == projectid && a.CustomerId == (int) settings.UserId
                select a).AsNoTracking().FirstOrDefaultAsync();

            RedisFunctions.SetData<Nftproject>(_redis, redisKey, project, 20);
        }
        else
            project = project1;

        if (project == null)
            NavigationManager.NavigateTo("/");
    }
}
