@page "/editnft/{nftid:int}"
@inject AppSettings settings
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<BreadCrumb Items="_items"></BreadCrumb>

<MudContainer MaxWidth="MaxWidth.False" Class="mt-4">
    
    <EditNftBase nftid="nftid" customerid="(int)settings.UserId" isAdmin="false" Backlink="@($"/managenft/{nftread.NftprojectId}")" SavedLink="@($"/managenft/{nftread.NftprojectId}/1")"></EditNftBase>
</MudContainer>


@code {
    [Parameter]
    public int nftid { get; set; }

    private Nft nftread = new();

    private readonly List<BreadcrumbItem> _items = new();

    protected override async Task OnParametersSetAsync()
    {
        await using var db = new EasynftprojectsContext(GlobalFunctions.optionsBuilder.Options);
        nftread = await (from a in db.Nfts
            .Include(a => a.Nftproject).AsSplitQuery()
            .Include(a => a.InverseMainnft)
            .ThenInclude(a => a.Metadata).AsSplitQuery()
            .Include(a => a.Metadata).AsSplitQuery()
            where a.Id == nftid && a.Nftproject.CustomerId == settings.UserId
            select a).FirstOrDefaultAsync();

        if (nftread == null)
        {
            LogClass.LogMessage(db, $"WARNING: User tried to get Access to a foreign account: {settings.UserId} - NFT id:{nftid}");
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopCenter;
            Snackbar.Add("Internal error - please contact support", Severity.Error);
            NavigationManager.NavigateTo("/projects");
            return;
        }

        _items.Add(new("Dashboard", href: "/"));
        _items.Add(new("NFT Projects", href: "/projects"));
        _items.Add(new($"Manage NFT ({nftread.Nftproject.Projectname})", $"/managenft/{nftread.NftprojectId}"));
        _items.Add(new("Edit NFT", href: $"/editnft/{nftid}", disabled: true));
    }
}
