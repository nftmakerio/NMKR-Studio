@layout LoginLayout
@page "/confirm/forgotpassword/{userid:int}/{confirmationcode}"
@inject NavigationManager NavigationManager
@inject IStringLocalizer _loc




<MudText Typo="Typo.h4" GutterBottom="true">@_loc["Change Password"]</MudText>
<EditForm Model="@registerdata" OnValidSubmit="@HandleValidSubmit">
    <DataAnnotationsValidator />

    <MudTextField Variant="Variant.Outlined" @bind-Value="@registerdata.Password" Label="@_loc["Password"]"  InputType="InputType.Password" For="@(() => registerdata.Password)" Class="mt-4" />
    <MudTextField Variant="Variant.Outlined" @bind-Value="@registerdata.Password2" Label="@_loc["Password confirmation"]"  InputType="InputType.Password" For="@(() => registerdata.Password2)" Class="mt-4" />

    <ReCAPTCHA @ref="reCAPTCHAComponent" SiteKey=@GeneralConfigurationClass.RecaptchaWebsite OnSuccess="OnSuccess" OnExpired="OnExpired" />

    <MudButton DropShadow="false" Variant="Variant.Filled" Class="mt-3 mr-3 rounded-xl px-6 py-3" Disabled="@isSubmitting" ButtonType="ButtonType.Submit" Color="Color.Tertiary" Size="Size.Large">@_loc["Change password"]</MudButton>
    <MudText Color="@Color.Error" Class="mt-3">
        @errormessage
    </MudText>
</EditForm>


@code { [CascadingParameter]
    public ConnectionInfo? ConnectionInfo { get; set; }
    [Parameter]
    public int UserId { get; set; }
    [Parameter]
    public string ConfirmationCode { get; set; }

    [Inject] private IDialogService DialogService { get; set; }
    public SetNewPasswordClass registerdata { get; set; }
    private string errormessage { get; set; }

    private ReCAPTCHA reCAPTCHAComponent;

    private bool ValidReCAPTCHA = false;

    private readonly bool ServerVerificatiing = false;

    private bool DisablePostButton => !ValidReCAPTCHA || ServerVerificatiing;

    private void OnSuccess()
    {
        ValidReCAPTCHA = true;
    }

    private void OnExpired()
    {
        ValidReCAPTCHA = false;
    }

    protected override void OnInitialized()
    {
        using var db = new EasynftprojectsContext(GlobalFunctions.optionsBuilder.Options);
        registerdata = new();
        var u = (from a in db.Customers
                 where a.Id == UserId
                 select a).AsNoTracking().FirstOrDefault();
        if (u == null)
        {
            NavigationManager.NavigateTo("/error",true);
            return;
        }
        if (u.Confirmationcode != ConfirmationCode)
        {
            NavigationManager.NavigateTo("/error", true);
        }

    }
    private bool isSubmitting;
    private async Task HandleValidSubmit()
    {
        if (isSubmitting)
            return;

        isSubmitting = true;


        try
        {
            if (!ValidReCAPTCHA)
            {
                errormessage = @_loc["Please confirm that you are not a bot"];
                isSubmitting = false;
                return;
            }
            await using var _db = new EasynftprojectsContext(GlobalFunctions.optionsBuilder.Options);
            var u = await (from a in _db.Customers
                           where a.Id == UserId
                           select a).FirstOrDefaultAsync();

            if (u == null)
            {
                errormessage = @_loc["Wrong parameters were passed. Please request a link again or contact support(1)"];
                isSubmitting = false;
                return;
            }

            if ( u.Confirmationcode != ConfirmationCode)
            {
                errormessage = @_loc["Wrong parameters were passed. Please request a link again or contact support (2)"];
                isSubmitting = false;
                return;
            }

            if (u.Pendingpasswordcreated < DateTime.Now.AddMinutes(-20))
            {
                errormessage = @_loc["The activation time has expired. Please request a new activation code"];
                return;
            }

            CryptographyProcessor cp = new();
            string salt = u.Salt;
            string hash = cp.GenerateHash(registerdata.Password, salt);


            u.Password = hash;
            u.Confirmationcode = "";

            await _db.SaveChangesAsync();

            bool? result = await DialogService.ShowMessageBox(
                @_loc["Information"],
                @_loc["Password successfully changed."]);

            NavigationManager.NavigateTo("/login");
        }
        finally
        {
            isSubmitting = false;
        }

    } }

