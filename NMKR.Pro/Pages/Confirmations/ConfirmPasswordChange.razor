@layout ConfirmationLayout
@page "/confirm/passwordchange/{userid:int}/{confirmationcode}"
@inject IStringLocalizer _loc



<MudText Typo="Typo.h4" GutterBottom="true">@_loc["Confirm password change"]</MudText>
<MudText Color="@Color.Error" Class="mt-3">
    @errormessage
</MudText>
<MudText Color="@Color.Primary" Class="mt-3">
    @message
</MudText>
<MudButton DropShadow="false" Variant="Variant.Filled" Color="Color.Tertiary" Class="mt-3 mr-3 rounded-xl px-6 py-3" Href="/login" Size="Size.Large">@_loc["Login"]</MudButton>



@code { [CascadingParameter]
    public ConnectionInfo? ConnectionInfo { get; set; }
    [Parameter]
    public int UserId { get; set; }
    [Parameter]
    public string ConfirmationCode { get; set; }

    private string message { get; set; }
    private string errormessage { get; set; }

 //   private EasynftprojectsContext _db = new EasynftprojectsContext(GlobalFunctions.optionsBuilder.Options);

    protected override void OnInitialized()
    {

    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await using var _db = new EasynftprojectsContext(GlobalFunctions.optionsBuilder.Options);
            var pending = (from a in _db.Customers
                           where a.Confirmationcode == ConfirmationCode && a.Id == UserId && a.State == "active"
                           select a).FirstOrDefault();

            if (pending == null)
            {
                errormessage = @_loc["The Code is not correct."];
                return;
            }

            if (pending.Pendingpasswordcreated < DateTime.Now.AddMinutes(-10))
            {
                errormessage = @_loc["The activation time has expired. Please request a new activation code."];
                return;
            }
            CryptographyProcessor cp = new();
            string hash = cp.GenerateHash(pending.Pendingpassword, pending.Salt);

            pending.Pendingpassword = null;
            pending.Pendingpasswordcreated = null;
            pending.Password = hash;

            await _db.SaveChangesAsync();
            message = @_loc["Your Password was successfully changed."];
            StateHasChanged();
        }
    } }
