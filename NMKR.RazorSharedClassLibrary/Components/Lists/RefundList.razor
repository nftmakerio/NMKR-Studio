@using BlazorDownloadFile
@using NMKR.Shared.Functions.Api
@using NMKR.Shared.Functions.Extensions
@inject IBlazorDownloadFileService BlazorDownloadFileService
@inject ISnackbar Snackbar

<MudOverlay Visible="OverlayIsVisible" DarkBackground="true" Absolute="true">
    <MudProgressCircular Indeterminate="true" />
</MudOverlay>

<MudTable ServerData="LoadTodos" Class="border" Hover="true" Bordered="false" Striped="false" Elevation="0" HorizontalScrollbar="true" T="Refundlog" Loading="isloading" Style="border-color:#E0E0E0; border-top-right-radius: 0px; border-top-left-radius: 0px;">
    <HeaderContent>
        <MudTh>Date/Time (UTC)</MudTh>
        <MudTh>Project</MudTh>
        <MudTh>Senderaddress</MudTh>
        <MudTh>Receiveraddress</MudTh>
        <MudTh>Amount</MudTh>
        <MudTh>Fee</MudTh>
        <MudTh>Blockchain</MudTh>
        <MudTh>Incoming TxHash</MudTh>
        <MudTh>Outgoing TxHash</MudTh>
        <MudTh>Reason</MudTh>
        <MudTh>State</MudTh>
    </HeaderContent>

    <RowTemplate>

        <MudTd>@(context.Created.ToShortDateString() + " " + context.Created.ToLongTimeString())</MudTd>
        <MudTd DataLabel="">@context.Nftproject?.Projectname</MudTd>
        <MudTd>
            <ShowAddress Address="@context.Senderaddress" Blockchain="@(context.Coin.ToEnum<Coin>().ToBlockchain())"></ShowAddress>
        </MudTd>
        <MudTd>
            <ShowAddress Address="@context.Receiveraddress" Blockchain="@(context.Coin.ToEnum<Coin>().ToBlockchain())"></ShowAddress>
        </MudTd>
            <MudTd>@context.Lovelace</MudTd>
        <MudTd>
            @(GlobalFunctions.FormatCurrency(context.Fee ?? 0, 5))
            @if (context.Nmkrcosts != 0)
            {
                <MudText Typo="Typo.body2">NMKR Costs: @(GlobalFunctions.FormatCurrency((context.Nmkrcosts),5))</MudText>
            }
        </MudTd>
        <MudTd><ShowBlockchainIcon Blockchain="@GlobalFunctions.ConvertToBlockchain(context.Coin.ToEnum<Coin>())" ShowText="true"></ShowBlockchainIcon>
            </MudTd>
        <MudTd>
            <ShowTransactionHash TxId="@context.Txhash" Blockchain="@((context.Coin.ToEnum<Coin>()).ToBlockchain())"></ShowTransactionHash>
        </MudTd>
        <MudTd>
            <ShowTransactionHash TxId="@context.Outgoingtxhash" Blockchain="@((context.Coin.ToEnum<Coin>()).ToBlockchain())"></ShowTransactionHash>
        </MudTd>
            <MudTd>@context.Refundreason</MudTd>
            <MudTd>@context.State</MudTd>
        </RowTemplate>


        <PagerContent>
            <MudTablePager HideRowsPerPage="true" />
        </PagerContent>
    </MudTable>
<MudButton DropShadow="false" HtmlTag="label2" Class="mb-5 mt-5 rounded-pill px-6 py-3"
           Variant="Variant.Filled"
           Color="Color.Tertiary" OnClick="ExportTransactions">
    Export all Refunds
</MudButton>

    @code {
    [Parameter]
    public int? customerid { get; set; }
    [Parameter]
    public int? projectid { get; set; }

    [Parameter]
    public IConnectionMultiplexer Redis { get; set; }

    [Inject]
    private IDialogService DialogService { get; set; }

    private bool isloading { get; set; }
    private int? DetailsId { get; set; }
    private bool isSubmitting { get; set; }
    private bool OverlayIsVisible { get; set; }

    private List<BreadcrumbItem> _items = new();


    private async Task ExportTransactions()
    {
        if (isSubmitting)
            return;

        isSubmitting = true;
        OverlayIsVisible = true;
        StateHasChanged();

        await using var db = new EasynftprojectsContext(GlobalFunctions.optionsBuilder.Options);
        var project=await (from a in db.Nftprojects
                             where a.Id == projectid
            select a).AsNoTracking().FirstOrDefaultAsync();
        if (project == null)
        {
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopCenter;
            Snackbar.Add("Error while exporting refunds (1) - Please contact the support", Severity.Error);
            isSubmitting = false;
            OverlayIsVisible = false;
            return;
        }
        var refunds = await ApiFunctions.CallGetRefundsAsync(project.Uid);

        if (refunds == null)
        {
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopCenter;
            Snackbar.Add("Error while exporting refunds (2) - Please contact the support", Severity.Error);
            isSubmitting = false;
            OverlayIsVisible = false;
            return;
        }
       


        var path = GeneralConfigurationClass.TempFilePath;
        string filteredfilename =/* GlobalFunctions.FilterTokenname(project.Projectname) + */ "_refunds";
        string filename = path + filteredfilename + ".zip";
        string csvfilename = path + filteredfilename + ".csv";
        Directory.CreateDirectory(path);
        GlobalFunctions.DeleteFile(filename);
        GlobalFunctions.DeleteFile(csvfilename);

        GlobalFunctions.DeleteOldFiles(path, 1);

        await using (var writer = new StreamWriter(csvfilename))
        await using (var csv = new CsvWriter(writer, CultureInfo.InvariantCulture))
        {
            await csv.WriteRecordsAsync(refunds);
        }


        using var archive = ZipFile.Open(filename, ZipArchiveMode.Create);
        archive.CreateEntryFromFile(csvfilename, Path.GetFileName(filteredfilename + ".csv"), CompressionLevel.Optimal);
        archive.Dispose();

        byte[] AsBytes = await File.ReadAllBytesAsync(filename);
        String AsBase64String = Convert.ToBase64String(AsBytes);

        await BlazorDownloadFileService.DownloadFile(filteredfilename + ".zip", AsBase64String, "application/octet-stream");
        GlobalFunctions.DeleteFile(csvfilename);

        OverlayIsVisible = false;
        isSubmitting = false;
    }


    public async Task<TableData<Refundlog>> LoadTodos(TableState state, CancellationToken cancellationToken)
    {
        isloading = true;
        StateHasChanged();
        await using var db = new EasynftprojectsContext(GlobalFunctions.optionsBuilder.Options);

        var transactions = await (from a in db.Refundlogs
            .Include(a => a.Nftproject).AsSplitQuery()
            where (a.NftprojectId == projectid || projectid == null) && (a.Nftproject.CustomerId==customerid || customerid==null)
                                  orderby a.Id descending
                                  select a).AsNoTracking().Skip(state.PageSize * state.Page).Take(state.PageSize).ToListAsync();

        int c = await (from a in db.Refundlogs
            where (a.NftprojectId == projectid || projectid == null) && (a.Nftproject.CustomerId==customerid || customerid==null)
                       select a).AsNoTracking().CountAsync();

        isloading = false;
        StateHasChanged();
        return new() { Items = transactions, TotalItems = c };
    }


}