 @inject IConnectionMultiplexer _redis;
 
 <MudOverlay Visible="OverlayIsVisible" DarkBackground="true" Absolute="true">
     <MudProgressCircular Indeterminate="true" />
 </MudOverlay>

 

 <MudTable Hover="true" Bordered="false" Striped="false" Elevation="0"
           HorizontalScrollbar="true" T="Splitroyaltyaddressestransaction" OnRowClick="@(args => OnRowClicked(args))" Loading="isloading" RowsPerPage="30"
           ServerData="LoadTodos">
     <HeaderContent>
         <MudTh>Date/Time (UTC)</MudTh>
         <MudTh Style="text-align:right">Amount</MudTh>
         <MudTh Style="text-align:right">Fees</MudTh>
         <MudTh Style="text-align:right">NMKR Costs</MudTh>
         <MudTh>Change Address</MudTh>
         <MudTh>TxHash</MudTh>
     </HeaderContent>

     <RowTemplate>

         <MudTd DataLabel="">@(context.Created.ToShortDateString() + " " + context.Created.ToLongTimeString())</MudTd>
         <MudTd Style="text-align:right" DataLabel="">@GlobalFunctions.FormatCurrency(context.Amount, 2) ADA</MudTd>
         <MudTd Style="text-align:right" DataLabel="">@GlobalFunctions.FormatCurrency(context.Fee, 5) ADA</MudTd>
         <MudTd Style="text-align:right" DataLabel="">@GlobalFunctions.FormatCurrency(context.Costs, 2) ADA</MudTd>
        <MudTd DataLabel=""><ShowAddress Address="@context.Changeaddress" Blockchain="Blockchain.Cardano"></ShowAddress></MudTd>
         <MudTd DataLabel="">
             <ShowTransactionHash TxId="@context.Txid" Blockchain="@(Blockchain.Cardano)"></ShowTransactionHash>
         </MudTd>
     </RowTemplate>

     <ChildRowContent>
         @if (context.Id == DetailsId)
         {
             <MudTr>
                 <td colspan="9">
                     <hr style="height: 1px; border-width: 0; color: #708090; background-color: #708090" />
                     <MudCard Elevation="0">
                         <MudCardHeader>
                             <CardHeaderContent>
                                 <MudText Typo="Typo.body1">Details for <strong>@context.Txid</strong></MudText>
                             </CardHeaderContent>
                         </MudCardHeader>
                         <MudCardContent Class="pa-0">

                             <MudSimpleTable Style="overflow-x: auto;">
                                 <thead>
                                 <tr>
                                     <th>Split address</th>
                                     <th Style="text-align:right">PercentageInt</th>
                                     <th Style="text-align:right">Amount</th>
                                 </tr>
                                 </thead>
                                 <tbody>
                                 @foreach (var splitContext in context.Splitroyaltyaddressestransactionssplits)
                                 {
                                     <tr>
                                            <td><ShowAddress Address="@splitContext.Splitaddress" Blockchain="Blockchain.Cardano"></ShowAddress></td>
                                         <td Style="text-align:right">@(splitContext.Percentage / 100) %</td>
                                         <td Style="text-align:right">@GlobalFunctions.FormatCurrency(splitContext.Amount, 5) ADA</td>
                                     </tr>
                                 }
                                 <tr>
                                     <td>NMKR Fee</td>
                                     <td></td>
                                     <td Style="text-align:right">@GlobalFunctions.FormatCurrency(context.Costs, 5) ADA</td>
                                 </tr>
                                 <tr>
                                     <td>Network Fee</td>
                                     <td></td>
                                     <td Style="text-align:right">@GlobalFunctions.FormatCurrency(context.Fee, 5) ADA</td>
                                 </tr>
                                 <tr>
                                     <td>
                                         Main Address <br />
                                            <ShowAddress Address="@context.Changeaddress" Blockchain="Blockchain.Cardano"></ShowAddress>
                                     </td>
                                     <td></td>
                                     <td Style="text-align:right">@GlobalFunctions.FormatCurrency(context.Amount - (context.Costs + context.Fee + context.Splitroyaltyaddressestransactionssplits.Sum(x => x.Amount)), 5) ADA</td>
                                 </tr>
                                 </tbody>
                             </MudSimpleTable>


                         </MudCardContent>
                     </MudCard>
                     <hr style="height: 1px; border-width: 0; color: #708090; background-color: #708090" />
                 </td>
             </MudTr>
         }
     </ChildRowContent>

     <PagerContent>
         <MudTablePager HideRowsPerPage="true" />
     </PagerContent>
 </MudTable>

 @code {
     [Parameter] public int splitaddressid { get; set; }
     [Parameter] public int CustomerId { get; set; }

    private int? DetailsId { get; set; }
    private bool isloading { get; set; } = false;
    private bool OverlayIsVisible { get; set; }

    public async Task<TableData<Splitroyaltyaddressestransaction>> LoadTodos(TableState state, CancellationToken cancellationToken)
    {
        string redisKey1 = $"{(GlobalFunctions.IsMainnet() ? "Mainnet" : "Testnet")}_Pro_ShowRoyaltySplitTransactions_{CustomerId}_{state.PageSize}_{state.Page}";
        var td1=RedisFunctions.GetData<TableData<Splitroyaltyaddressestransaction>>(_redis, redisKey1);

        if (td1 != null)
        {
            return td1;
        }


        isloading = true;
        StateHasChanged();
        await using var db = new EasynftprojectsContext(GlobalFunctions.optionsBuilder.Options);

        var transactions = await (from a in db.Splitroyaltyaddressestransactions
            .Include(a => a.Splitroyaltyaddressestransactionssplits).AsSplitQuery()
            where a.SplitroyaltyaddressesId==splitaddressid 
            orderby a.Id descending
            select a).AsNoTracking().Skip(state.PageSize * state.Page).Take(state.PageSize).ToListAsync();

        int c = await (from a in db.Splitroyaltyaddressestransactions
            where a.SplitroyaltyaddressesId==splitaddressid 
            orderby a.Id descending
            select a).AsNoTracking().CountAsync();


        isloading = false;
        StateHasChanged();
            
        var td= new TableData<Splitroyaltyaddressestransaction>() { Items = transactions, TotalItems = c };
        RedisFunctions.SetData<TableData<Splitroyaltyaddressestransaction>>(_redis, redisKey1, td, 30);
        return td;
    }
    private void OnRowClicked(TableRowClickEventArgs<Splitroyaltyaddressestransaction> trans)
    {
        if (trans.Item == null)
            return;

        if (DetailsId == trans.Item.Id)
        {
            DetailsId = null;
        }
        else
        {
            DetailsId = trans.Item.Id;
        }
        StateHasChanged();
    }
}
