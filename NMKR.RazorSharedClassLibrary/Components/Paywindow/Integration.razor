@inject ClipboardService ClipboardService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.False" Class="mt-4">
    @if (project != null)
    {
        <MudText Typo="Typo.h3" Color="Color.Dark" Class="mb-4">Integration</MudText>
        <MudTabs Elevation="0" Class="border mb-4" Style="border-color:#E0E0E0; background-color: white;" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
            <MudTabPanel Text="NMKR Pay" Icon="@Icons.Material.Filled.Web">
                <IntegrationPaywindow IsAdmin="@IsAdmin" ProjectId="project.Id" ></IntegrationPaywindow>
            </MudTabPanel>
            @if (ShowPayinAddressIntegration)
            {
                <MudTabPanel Text="Pay-In Address" Icon="@Icons.Material.Filled.Input">
                    <IntegrationPayinAddress project="project"></IntegrationPayinAddress>
                </MudTabPanel>
            }
            <MudTabPanel Text="Api" Icon="@Icons.Material.Filled.Api">
                <IntegrationApi IsAdmin="@IsAdmin" project="project"></IntegrationApi>
            </MudTabPanel>
        </MudTabs>
    }
</MudContainer>

@code {
    [Inject] private IDialogService DialogService { get; set; }

    [Parameter]
    public Nftproject? project { get; set; }

    [Parameter]
    public bool IsAdmin { get; set; } = false;
    private bool ShowPayinAddressIntegration { get; set; } = false;

    protected override async Task OnParametersSetAsync()
    {
        await Reload();
    }

    private async Task Reload()
    {
        if (project == null)
            return;

        await using var db = new EasynftprojectsContext(GlobalFunctions.optionsBuilder.Options);
        var prices = await (from a in db.Pricelists
                            where a.NftprojectId == project.Id && a.Currency != Coin.ADA.ToString()
            select a).ToListAsync();

        if (prices.Any())
        {
            ShowPayinAddressIntegration = false;
            StateHasChanged();
        }
        else
        {
            ShowPayinAddressIntegration = true;
            StateHasChanged();
        }
    }
}