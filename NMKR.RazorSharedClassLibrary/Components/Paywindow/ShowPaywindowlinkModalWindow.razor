@inject ClipboardService ClipboardService
@inject ISnackbar Snackbar
@inject IJSRuntime JS
@inject IConnectionMultiplexer redis
<MudDialog Style="padding: 20px; ">
    <TitleContent>
        <MudText Typo="Typo.h3">
            Specific Token Sale via NMKR Pay
        </MudText>
    </TitleContent>
    <DialogContent>
        @if (nft != null && nft.Nftproject.Maxsupply > 1)
        {
            <MudSelect T="long" Label="Token Amount" @bind-Value="tokencount">
                @foreach (var p in nft.Nftproject.Pricelists)
                {
                    <MudSelectItem Value="p.Countnftortoken">@p.Countnftortoken (@GlobalFunctions.FormatCurrency(GlobalFunctions.GetPriceInEntities(redis,p), 2) ADA)</MudSelectItem>
                }
            </MudSelect>
        }

        <MudTextField Variant="Variant.Outlined" ReadOnly="true" T="string" Label="NMKR Pay Link" Text="@paylink" Class="mt-4" />
    </DialogContent>
    <DialogActions >
        <MudButton DropShadow="false" Class="rounded-xl px-6 py-3" Variant="Variant.Outlined" Color="Color.Secondary" OnClick="Cancel">Close</MudButton>

        <MudButton DropShadow="false" Class="rounded-xl px-6 py-3" StartIcon="@Icons.Material.Filled.Payment" Color="Color.Tertiary" Variant="Variant.Filled" OnClick="Try">Open</MudButton>
        <MudButton DropShadow="false" Class="rounded-xl px-6 py-3" StartIcon="@Icons.Material.Filled.ContentCopy" Color="Color.Tertiary" Variant="Variant.Filled" OnClick="CopyToClipboard">Copy link to clipboard</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; }
    [Parameter]
    public Nft nft { get; set; }

    private long _tokencount = 1;

    private long tokencount
    {
        get => _tokencount;
        set
        {
            _tokencount = value;
            SetPaylink();
        }
    }

    private string paylink { get; set; }
    void Cancel() => MudDialog.Cancel();

    private async Task CopyToClipboard()
    {
        // Writing to the clipboard may be denied, so you must handle the exception
        try
        {
            await ClipboardService.WriteTextAsync(paylink);
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopCenter;
            Snackbar.Add("Payment Gateway link copied to clipboard", Severity.Success);
        }
        catch
        {
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopCenter;
            Snackbar.Add("Copy to clipboard was denied", Severity.Error);
        }
    }

    private async Task Try()
    {
        await JS.InvokeAsync<string>("openPaymentWindow", paylink);
    }

    protected override async Task OnParametersSetAsync()
    {
        if (nft.Nftproject.Pricelists.Any())
            tokencount = nft.Nftproject.Pricelists.First().Countnftortoken;
        SetPaylink();
    }

    private void SetPaylink()
    {
        paylink = GeneralConfigurationClass.Paywindowlink + "p=" + nft.Nftproject.Uid.Replace("-", "") + "&n=" + nft.Uid.Replace("-", "");

        if (nft.Nftproject.Maxsupply > 1)
        {
            paylink += "&tc=" + _tokencount;
        }
    }

}