@inject ISnackbar Snackbar
@inject IJSRuntime jsRuntime
@inject NavigationManager NavigationManager
@inject ClipboardService ClipboardService


    <MudText Typo="Typo.h3" Color="Color.Dark" Class="mb-4">Auctions</MudText>

    <MudTable Items="@auctions" Hover="true" Bordered="true" Striped="false" HorizontalScrollbar="true" T="Legacyauction" Loading="@progressIsVisible">
        <HeaderContent>
            <MudTh>Auction name</MudTh>
            <MudTh>State</MudTh>
            <MudTh Style="text-align:right">Min. price</MudTh>
            <MudTh Style="text-align:right">Actual bet</MudTh>
            <MudTh Style="text-align:right">Royalties</MudTh>
            <MudTh Style="text-align:right">MktPlc Fee</MudTh>
            <MudTh>Created (UTC)</MudTh>
            <MudTh>Runs until (UTC)</MudTh>
            <MudTh>Image</MudTh>
            <MudTh>NFT/Token</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>

        <RowTemplate>
            
            <MudTd>
                @context.Auctionname
                <br/><br/>
                <small>UID: <ShowUid Uid="@context.Uid"></ShowUid>"</small>
            </MudTd>
            
            <MudTd>
                @switch (context.State)
                {
                    case "active":
                        <NMKRChip Color="Color.Success" Size="Size.Small" Variant="Variant.Filled">Running</NMKRChip>
                        break;
                    case "notactive":
                        <NMKRChip Color="Color.Warning" Size="Size.Small" Variant="Variant.Filled">Not active (no NFT locked)</NMKRChip>
                        break;
                    case "finished":
                        <NMKRChip Color="Color.Secondary" Size="Size.Small" Variant="Variant.Filled">Finished @(context.Actualbet>0?"(NFT sold)":"(NFT not sold)")</NMKRChip>
                        break;
                    case "ended":
                        <NMKRChip Color="Color.Secondary" Size="Size.Small" Variant="Variant.Filled">Finished</NMKRChip>
                        break;
                    case "waitforlock":
                        <NMKRChip Color="Color.Info" Size="Size.Small" Variant="Variant.Filled">Wait for NFT lock</NMKRChip><br/>
                        <small>Send your NFT to the lock address to start the auction</small>
                        break;
                }
            </MudTd>
            
            <MudTd Style="text-align: right">
                @GlobalFunctions.FormatCurrency(context.Minbet,2) ADA
            </MudTd>
            <MudTd Style="text-align: right">
                @GlobalFunctions.FormatCurrency(context.Actualbet,2) ADA
            </MudTd>
            
            <MudTd Style="text-align: right">
                @(context.Royaltyfeespercent==null?"":context.Royaltyfeespercent +" %")
            </MudTd>
            <MudTd Style="text-align: right">
                @(context.Marketplacefeepercent==null?"":context.Marketplacefeepercent +" %")
            </MudTd>
            <MudTd >
                @context.Created
            </MudTd>
            <MudTd >
                @context.Runsuntil
            </MudTd>
            <MudTd>
                @if (context.LegacyauctionsNfts.Any() && !string.IsNullOrEmpty(context.LegacyauctionsNfts.First().Ipfshash))
                {
                    <a href="@(GeneralConfigurationClass.IPFSGateway+ context.LegacyauctionsNfts.First().Ipfshash)" target="_blank"> <img src="@(GeneralConfigurationClass.IPFSGateway+context.LegacyauctionsNfts.First().Ipfshash)" height="50"></a>
                }
            </MudTd>
            <MudTd>
                @if (context.LegacyauctionsNfts.Any() )
                {
                    <MudText>@context.LegacyauctionsNfts.First().Tokencount x @GlobalFunctions.FromHexString(context.LegacyauctionsNfts.First().Tokennamehex)</MudText>

                <small>Policy:  <ShowPolicyId PolicyId="@context.LegacyauctionsNfts.First().Policyid"></ShowPolicyId></small>

                <br />
                    <small>Hex: @context.LegacyauctionsNfts.First().Tokennamehex</small>
                }
            </MudTd>
            <MudTd Style="text-align: right">
                <MudNavLink @onclick="() => Edit(context.Id)" Icon="@NMKRIcons.Edit">Edit</MudNavLink>
                <MudDivider Class="my-2"/>
                @if (context.State == "waitforlock")
                {
                    <MudNavLink @onclick="() => LockNft(context.Id)" Icon="@Icons.Material.Filled.Lock">Lock NFT on Auction</MudNavLink>
                }

                @if (context.State == "active")
                {
                    <MudNavLink @onclick="() => ShowAddress(context.Id)" Icon="@Icons.Material.Filled.Payment">Show auction address</MudNavLink>
                }
                @if (context.State != "waitforlock")
                {
                    <MudNavLink @onclick="() => ShowHistory(context.Id)" Icon="@Icons.Material.Filled.History">Show auction history</MudNavLink>
                }
                @if (context.State != "active")
                {
                    <MudNavLink @onclick="() => Delete(context.Id)" Icon="@NMKRIcons.Delete">Delete</MudNavLink>
                }
            </MudTd>
        </RowTemplate>

        <PagerContent>
            <MudTablePager HideRowsPerPage="true" />
        </PagerContent>
    </MudTable>

    <MudButton DropShadow="false" 
        Class="mt-5 mb-5 rounded-pill px-6 py-3"
        Variant="Variant.Filled"
        Color="Color.Tertiary"
        StartIcon="@Icons.Material.Filled.AccountBalanceWallet"
        OnClick="Add">
        Create new auction
    </MudButton>

@code {
    [Parameter]
    public int CustomerId { get; set; }
    [Inject] private IDialogService DialogService { get; set; }
    private bool progressIsVisible { get; set; }
    private bool isSubmitting;

    private List<Legacyauction> auctions = new();

    protected override async Task OnParametersSetAsync()
    {
        await ReloadData();
    }

    private async Task ReloadData()
    {
        await using EasynftprojectsContext db = new(GlobalFunctions.optionsBuilder.Options);

        progressIsVisible = true;
        StateHasChanged();
        auctions = await (from a in db.Legacyauctions
            .Include(a=>a.LegacyauctionsNfts)
            .AsSplitQuery()
                         where a.CustomerId == CustomerId && a.State!="deleted"
                             orderby a.Created descending 
                         select a).AsNoTracking().ToListAsync();

        progressIsVisible = false;
        StateHasChanged();
    }

    private async Task Delete(int id)
    {
        if (isSubmitting)
            return;

        isSubmitting = true;
        bool? result = await DialogService.ShowMessageBox(
        "Warning",
        "Are you sure you want to delete this auction?",
        yesText: "Delete!", cancelText: "Cancel");
        if (result != null)
        {
            await using EasynftprojectsContext db = new(GlobalFunctions.optionsBuilder.Options);

            var p = await (from a in db.Legacyauctions
                           where a.Id == id && a.CustomerId == CustomerId 
                           select a).FirstOrDefaultAsync();
            if (p != null)
            {
                p.State = "deleted";
                await db.SaveChangesAsync();
                await ReloadData();
                Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopCenter;
                Snackbar.Add("Auction deleted", Severity.Success);
            }
            else
            {
                Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopCenter;
                Snackbar.Add("Internal error - Please contact support", Severity.Error);
            }
        }
        isSubmitting = false;
        StateHasChanged();
    }

    private async Task Edit(int id)
    {
        if (isSubmitting)
            return;

        isSubmitting = true;
        await using EasynftprojectsContext db = new(GlobalFunctions.optionsBuilder.Options);

        var auction = await (from a in db.Legacyauctions
            where a.Id == id && a.CustomerId == CustomerId
            select a).FirstOrDefaultAsync();

        if (auction == null)
        {
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopCenter;
            Snackbar.Add("Internal error - Please contact support", Severity.Error);
            isSubmitting = false;
            return;
        }
        if (auction.State == "running")
        {
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopCenter;
            Snackbar.Add("Auction is already running - change not possible", Severity.Error);
            isSubmitting = false;
            return;
        }
        if (auction.State == "finished")
        {
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopCenter;
            Snackbar.Add("Auction is already finished - change not possible", Severity.Error);
            isSubmitting = false;
            return;
        }
        if (auction.State == "ended")
        {
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopCenter;
            Snackbar.Add("Auction is canceled - change not possible", Severity.Error);
            isSubmitting = false;
            return;
        }

        EditAuctionClass newauction = new() {Id = auction.Id, RunsUntil = auction.Runsuntil, SellerAddress = auction.Selleraddress, AuctionName = auction.Auctionname, MinBet = auction.Minbet / 1000000, RunsUntilTime = auction.Runsuntil.TimeOfDay};
        var parameters = new DialogParameters {{nameof(EditAuctionsModalWindow.auction), newauction},{nameof(EditAuctionsModalWindow.CustomerId), CustomerId}};
        DialogOptions maxWidth = new() {MaxWidth = MaxWidth.Large, FullWidth = true, BackdropClick = false};
        var dialog = await DialogService.ShowAsync<EditAuctionsModalWindow>("Edit auction", parameters, maxWidth);
        var result = await dialog.Result;

        if (result != DialogResult.Cancel())
        {
            await ReloadData();
        }
      
        isSubmitting = false;
        StateHasChanged();
    }

    private async Task ShowAddress(int id)
    {
        if (isSubmitting)
            return;
        isSubmitting = true;

        await using EasynftprojectsContext db = new(GlobalFunctions.optionsBuilder.Options);
        var auction = await (from a in db.Legacyauctions
            where a.Id == id && a.CustomerId == CustomerId
            select a).FirstOrDefaultAsync();


        var parameters = new DialogParameters { { nameof(ShowAuctionAddressModalWindow.auctionaddress), auction.Address }, {nameof(ShowAuctionAddressModalWindow.description),"Give this address to your customers. They can simply send ADA there to participate in the auction. The highest bid in each case will remain locked until a higher bid is received. At the end of the auction, the buyer gets the NFT and you get the purchase amount minus the commission and royalties."} };

        DialogOptions maxWidth = new() {MaxWidth = MaxWidth.Large, FullWidth = true, BackdropClick = false};
        var dialog = await DialogService.ShowAsync<ShowAuctionAddressModalWindow>("Show auction address", parameters, maxWidth);
        var result = await dialog.Result;

        if (result != DialogResult.Cancel())
        {
            await ReloadData();
        }
        
      
        isSubmitting = false;
        StateHasChanged();
    }

    private void ShowHistory(int id)
    {
        NavigationManager.NavigateTo($"/auctionhistory/{id}");
    }


    private async Task LockNft(int id)
    {
        if (isSubmitting)
            return;

        isSubmitting = true;
        await using EasynftprojectsContext db = new(GlobalFunctions.optionsBuilder.Options);
        var auction = await (from a in db.Legacyauctions
            where a.Id == id && a.CustomerId == CustomerId
            select a).FirstOrDefaultAsync();

        if (auction == null)
        {
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopCenter;
            Snackbar.Add("Internal error - Please contact support", Severity.Error);
            isSubmitting = false;
            return;
        }
        if (auction.State == "running")
        {
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopCenter;
            Snackbar.Add("Auction is already running - lock not possible", Severity.Error);
            isSubmitting = false;
            return;
        }
        if (auction.State == "finished")
        {
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopCenter;
            Snackbar.Add("Auction is already finished - lock not possible", Severity.Error);
            isSubmitting = false;
            return;
        }
        if (auction.State == "ended")
        {
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopCenter;
            Snackbar.Add("Auction is canceled - lock not possible", Severity.Error);
            isSubmitting = false;
            return;
        }

        var parameters = new DialogParameters { { nameof(ShowAuctionAddressModalWindow.auctionaddress), auction.Address }, {nameof(ShowAuctionAddressModalWindow.description),"To sell a NFT on this auction, send it to the Address below - together with 2 ADA (!). You will see the NFT in the auctions list after locking."} };

        DialogOptions maxWidth = new() {MaxWidth = MaxWidth.Large, FullWidth = true, BackdropClick = false};
        var dialog = await DialogService.ShowAsync<ShowAuctionAddressModalWindow>("Show auction address", parameters, maxWidth);
        var result = await dialog.Result;

        if (result != DialogResult.Cancel())
        {
            await ReloadData();
        }


      
        isSubmitting = false;
        StateHasChanged();
    }
    private async Task Add()
    {
        if (isSubmitting)
            return;

        isSubmitting = true;

        EditAuctionClass newauction = new() {Id=null , RunsUntil = DateTime.Now.AddDays(7), RunsUntilTime = DateTime.Now.TimeOfDay, MinBet = 3};
        var parameters = new DialogParameters {{nameof(EditAuctionsModalWindow.auction), newauction}, {nameof(EditAuctionsModalWindow.CustomerId), CustomerId}};
        DialogOptions maxWidth = new() {MaxWidth = MaxWidth.Large, FullWidth = true, BackdropClick = false};
        var dialog = await DialogService.ShowAsync<EditAuctionsModalWindow>("Add auction", parameters, maxWidth);
        var result = await dialog.Result;

        if (result != DialogResult.Cancel())
        {
            await ReloadData();
        }

        isSubmitting = false;
        StateHasChanged();
    }
}
